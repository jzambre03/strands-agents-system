<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golden Config AI - Drift Review Assistant</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <style>
    :root{
      --vz-red:#B91C1C; --med:#D97706; --low:#4B5563; --allowed: #6B7280;
      --ink:#111827; --muted:#6B7280; --bg:#F9FAFB;
      --panel:#FFFFFF; --line:#E5E7EB; --chip:#F3F4F6;
      --shadow:0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.07);
      --add-bg:#E0F2F1; --add-text:#00796B; --add-inline-bg: #D1FAE5;
      --del-bg:#FFEBEE; --del-text:#C62828; --del-inline-bg: #FEE2E2;
      --insight-bg: #FEFCE8; --insight-border: #FBBF24;
      --allowed-bg: #F3F4F6;
      --success: #10B981; --success-bg: #D1FAE5;
    }
    *{box-sizing:border-box}
    html,body,#root{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    .container{max-width:1400px;margin:0 auto;padding:24px}
    .header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    .title{font-weight:600; font-size: 1.1em; line-height: 1.4;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9em;}

    .btn{border:1px solid #D1D5DB;background:#FFFFFF;color:#374151;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600; transition: background-color 0.2s;}
    .btn:hover{background-color: #F9FAFB;}
    .btn.primary{background: #1F2937; color: white; border-color: #1F2937;}
    .btn.primary:hover{background: #374151;}
    .btn.success{background: var(--success); color: white; border-color: var(--success);}
    .btn.success:hover{background: #059669;}
    .btn:disabled{background:#F3F4F6;color:#9CA3AF;border-color:#E5E7EB;cursor:not-allowed;}
    
    .toggle-btn{
        background: var(--chip);
        border: 1px solid var(--line);
        color: var(--muted);
        cursor: pointer;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        font-size: 20px;
        line-height: 26px;
        text-align: center;
        transition: background-color 0.2s, transform 0.2s;
        font-weight: 500;
    }
    .toggle-btn:hover{ background-color: #E5E7EB; }
    .toggle-btn.open{ transform: rotate(45deg); }

    .stats{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
    .stat{text-align:center;padding:20px 16px;min-height:100px;display:flex;flex-direction:column;justify-content:center}
    .stat .val{font-size:28px;font-weight:700;line-height:1.1;margin-bottom:4px}
    .stat .lbl{font-size:14px;color:var(--muted);font-weight:600;line-height:1.2}
    .stat.clickable{transition: all 0.2s ease; transform: scale(1);}
    .stat.clickable:hover{transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
    .chip{display:inline-block; background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:4px 12px;font-size:12px;font-weight:500;}
    
    .issue-card{padding: 0;}
    .issue-header{display:flex; justify-content: space-between; align-items: center; gap: 16px; padding: 16px; cursor: pointer; border-radius: 16px; transition: background-color 0.2s;}
    .issue-header:hover{background-color: #FAFAFA;}
    .issue-summary{flex: 1;}
    .issue-details{padding: 16px; display: flex; flex-direction: column; gap: 16px; border-top: 1px solid var(--line);}
    .details-actions{display: flex; justify-content: flex-end; gap: 8px;}
    
    .issue-meta{display: flex; flex-wrap: wrap; align-items:center; gap:8px; margin-top: 8px;}
    .churn-pill{font-weight: 600; font-size: 12px;}
    .churn-pill .add{color: var(--add-text);}
    .churn-pill .del{color: var(--del-text);}
    
    .pii-notice { color: #B45309; background: #FFFBEB; border-color: #FDE68A; }

    .insight-card{background: var(--insight-bg); border-left: 4px solid var(--insight-border); padding: 12px; border-radius: 8px;}
    .insight-card .heading{font-weight: 700; font-size: 1em; color: #92400E; margin-bottom: 4px;}
    
    .diff-view{border:1px solid var(--line);border-radius:12px;max-height:350px;overflow:auto;}
    .diff-line{padding: 4px 12px; white-space:pre-wrap; border-left: 3px solid transparent;}
    .diff-line.hdr{background:#F3F4F6; color: var(--muted); font-style: italic;}
    .diff-line.add{background:var(--add-bg); border-left-color: var(--add-text);}
    .diff-line.del{background:var(--del-bg); border-left-color: var(--del-text);}
    
    .inline-diff-view {border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: #FAFAFA;}
    .diff-inline-del {background-color: var(--del-inline-bg); padding: 1px 4px; border-radius: 4px; text-decoration: line-through;}
    .diff-inline-add {background-color: var(--add-inline-bg); padding: 1px 4px; border-radius: 4px;}

    .grid-issues{display:grid;gap:16px}
    .section-title{font-size: 1.5em; font-weight: 700; margin-bottom: 16px; padding-bottom: 8px;}
    .error{background:#FFFBEB;border:1px solid #FBBF24;color:#92400E;padding:12px;border-radius:12px}
    .success-banner{background:var(--success-bg);border:1px solid var(--success);color:#065F46;padding:16px;border-radius:12px;margin-bottom:16px;}
    .loading{text-align:center;padding:48px;color:var(--muted);}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid var(--line);border-top-color:var(--vz-red);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    (function(){
      const onError = (msg, src, line, col, err) => {
        const details = (err && (err.stack || err.message)) || String(msg);
        const el = document.createElement('div'); el.className = 'card error'; el.style.margin = '16px';
        el.textContent = 'Runtime error: ' + details; document.body.prepend(el);
      };
      window.onerror = onError;
      window.addEventListener('unhandledrejection', e => onError(e.reason||'Unhandled Promise rejection'));

      const e = React.createElement;
      
      const MASKING_PATTERNS = [
          { regex: /(PASSWORD|SECRET|KEY|TOKEN)\s*[:=]\s*([^\s]+)/gi, replacement: "$1: '********'" },
          { regex: /(AES:)[^\s]+/gi, replacement: "$1********" }
      ];

      function maskPII(text) {
          if (typeof text !== 'string') return '';
          let maskedText = text;
          MASKING_PATTERNS.forEach(({ regex, replacement }) => { maskedText = maskedText.replace(regex, replacement); });
          return maskedText;
      }

      function hasPII(text) {
          if (typeof text !== 'string') return false;
          return MASKING_PATTERNS.some(({ regex }) => { regex.lastIndex = 0; return regex.test(text); });
      }

      function getChangeType(item) {
        // PRIORITY 1: Use drift_category from LLM output if available
        if (item.drift_category) {
          return item.drift_category;
        }
        
        // PRIORITY 2: Fallback to pattern-based detection (legacy support)
        const { file, why = '' } = item;
        if (why.includes('dependency')) return 'Dependency';
        if (file.endsWith('.yml') || file.endsWith('.properties') || why.includes('connection string')) return 'Configuration';
        if (file.endsWith('pom.xml') || file.startsWith('helm/')) return 'Build & Deployment';
        if (why.includes('probe') || why.includes('security') || why.includes('password') || why.includes('username escalated')) return 'Security & Health';
        if (file.endsWith('.java')) return 'Code Logic';
        return 'General';
      }

      function generateInsight(item) {
          // PRIORITY 1: Use AI-generated insights from LLM output (ai_review_assistant field)
          if (item.ai_review_assistant && 
              item.ai_review_assistant.potential_risk && 
              item.ai_review_assistant.suggested_action) {
              return e('div', {className: 'insight-card'}, [
                e('div', {className: 'heading'}, '💡 AI Review Assistant'),
                e('p', {style: {margin: 0}}, [ 
                  e('strong', null, 'Potential Risk: '), 
                  maskPII(item.ai_review_assistant.potential_risk), 
                  e('br'), 
                  e('strong', null, 'Suggested Action: '), 
                  maskPII(item.ai_review_assistant.suggested_action) 
                ])
              ]);
          }
          
          // PRIORITY 2: Derive insights from 'why' field if AI data is missing (legacy/fallback support)
          const { why = '' } = item;
          let insight = { risk: 'N/A', action: 'Review the change details below.' };
          const maskedWhy = maskPII(why);
          
          // Pattern-based fallback for backward compatibility
          if (maskedWhy.includes('null safety check')) {
              insight = { risk: 'May cause NullPointerExceptions if input is not handled upstream.', action: 'Verify input is guaranteed to be valid or reject this change.' };
          } else if (maskedWhy.includes('Database connection string changed') || maskedWhy.includes('connection string')) {
              insight = { risk: 'Pointing the application to a new database can cause data corruption or breaches.', action: 'Confirm with the infrastructure team that this endpoint change is authorized.' };
          } else if (maskedWhy.includes('username escalated') || maskedWhy.includes('privileges')) {
              insight = { risk: 'Escalating database privileges increases the attack surface.', action: 'This change requires senior approval. Verify the justification for these new permissions.' };
          } else if (maskedWhy.includes('password modified') || maskedWhy.includes('credential')) {
              insight = { risk: 'Unauthorized credential changes are a critical security threat.', action: 'Immediately verify this change with the security and operations teams.' };
          } else if (maskedWhy.includes('Liveness probe') || maskedWhy.includes('health check')) {
              insight = { risk: 'Weakened health checks can hide application instability, delaying recovery.', action: 'Consult SRE/DevOps to ensure this change meets reliability standards.' };
          } else if (maskedWhy.includes('dependency downgraded') || maskedWhy.includes('downgrade')) {
              insight = { risk: 'Downgrading dependencies can re-introduce known vulnerabilities.', action: 'Scan the old version for CVEs and confirm the reason for the downgrade.' };
          }
          
          return e('div', {className: 'insight-card'}, [
            e('div', {className: 'heading'}, '💡 AI Review Assistant'),
            e('p', {style: {margin: 0}}, [ 
              e('strong', null, 'Potential Risk: '), 
              insight.risk, 
              e('br'), 
              e('strong', null, 'Suggested Action: '), 
              insight.action 
            ])
          ]);
      }

      const PIINotice = () => e('span', {className: 'chip pii-notice'}, '🔒 PII Masked');
      
      const LocatorPill = ({loc}) => {
          if(!loc) return null;
          let text = '';
          if (loc.type === 'unidiff' && loc.old_start) { text = `Lines ${loc.old_start} → ${loc.new_start || loc.old_start}`; } 
          else if (loc.line_start) { text = `Line ${loc.line_start}`; } 
          else { text = loc.type || 'General'; }
          return e('span',{className:'chip mono'}, text);
      };

      const Churn = ({ loc }) => {
        if (loc.type !== 'unidiff' || loc.old_lines === undefined) return null;
        const netChange = (loc.new_lines || 0) - (loc.old_lines || 0);
        const additions = Math.max(0, netChange);
        const deletions = Math.max(0, -netChange);
        return e('span', {className: 'chip mono churn-pill'}, [ e('span', {className: 'add'}, `+${additions} `), e('span', {className: 'del'}, `-${deletions}`) ]);
      };
      
      const CodeHunkIssue = ({ item }) => {
        const uiPatch = React.useMemo(() => item.remediation?.patch_hint?.replace(/\\n/g, '\n') || '', [item]);
        const lines = uiPatch.split('\n').filter(ln => !ln.startsWith('---') && !ln.startsWith('+++') && !ln.startsWith('diff --git'));
        return e('div', {className: 'diff-view mono'}, lines.map((ln, i) => e('div', {key: i, className: `diff-line ${ln.startsWith('@@')?'hdr':ln.startsWith('+')?'add':ln.startsWith('-')?'del':'ctx'}`}, maskPII(ln))));
      };

      const ConfigChangeIssue = ({ item }) => {
        const { old = null, new: newVal = null, remediation = {} } = item;
        const maskedOld = maskPII(old || '');
        const maskedNew = maskPII(newVal || '');
        
        const elements = [];
        
        // Show the actual config change (old vs new)
        if (maskedOld || maskedNew) {
          elements.push(
            e('div', { key: 'change', className: 'diff-view mono' }, [
              maskedOld && e('div', { key: 'old', className: 'diff-line del' }, `- ${maskedOld}`),
              maskedNew && e('div', { key: 'new', className: 'diff-line add' }, `+ ${maskedNew}`)
            ].filter(Boolean))
          );
        }
        
        // Show remediation steps if available from LLM output
        if (remediation.steps && Array.isArray(remediation.steps) && remediation.steps.length > 0) {
          elements.push(
            e('div', { key: 'steps', style: {marginTop: '12px'} }, [
              e('strong', null, '🔧 Remediation Steps:'),
              e('ol', { style: {margin: '8px 0', paddingLeft: '20px'} }, 
                remediation.steps.map((step, i) => 
                  e('li', {key: i, style: {marginBottom: '4px'}}, maskPII(step))
                )
              )
            ])
          );
        }
        
        return e('div', null, elements);
      };
      
      function Issue({item, bucket}) {
        const [open, setOpen] = React.useState(false);
        const patch = item.remediation?.patch_hint || '';
        const itemContainsPII = React.useMemo(() => hasPII(item.why) || hasPII(item.remediation?.snippet) || hasPII(item.remediation?.patch_hint), [item]);

        function downloadPatch(){ if(!patch) return; const blob=new Blob([patch],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(item.id || 'issue')+'.patch'; a.click(); URL.revokeObjectURL(a.href); }
        function downloadJSON(){ const blob=new Blob([JSON.stringify(item,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(item.id || 'issue')+'.json'; a.click(); URL.revokeObjectURL(a.href); }
        
        const DetailsView = item.remediation?.patch_hint ? CodeHunkIssue : item.remediation?.snippet ? ConfigChangeIssue : () => e('div', {className: 'muted'}, 'No detailed changes available.');
        const riskVar = bucket === 'high' ? 'vz-red' : (bucket === 'medium' ? 'med' : 'low');

        return e('div', {className: 'card issue-card'}, [
            e('div', { className: 'issue-header', onClick: () => setOpen(!open) }, [
                e('div', { className: 'issue-summary' }, [
                    e('p', {className: 'title'}, maskPII(item.why || item.headline)),
                    e('div', {className: 'issue-meta'}, [
                        e('span', {className:'chip', style:{backgroundColor: `var(--${riskVar})`, color: 'white'}}, String(bucket).toUpperCase()),
                        e('span', {className: 'chip'}, getChangeType(item)),
                        e(Churn, {loc: item.locator}),
                        itemContainsPII && e(PIINotice),
                        e('span', {className: 'mono muted'}, item.file)
                    ]),
                ]),
                e('button', {className: `toggle-btn ${open ? 'open': ''}`}, '+')
            ]),
            open && e('div', { className: 'issue-details' }, [
                generateInsight(item),
                e(DetailsView, {item}),
                e('div', {className: 'details-actions'}, [
                    e('button', {className: 'btn', onClick: downloadJSON}, 'Download JSON'),
                    e('button', {className: 'btn primary', onClick: downloadPatch, disabled: !patch}, 'Download Patch')
                ])
            ])
        ]);
      }
      
      const AllowedVarianceIssue = ({item}) => e('div', {className:'card', style:{padding:'16px'}}, [
        e('div', {style:{display: 'flex', alignItems: 'center', gap:'12px', marginBottom: '8px'}}, [
            e('div', {className:'chip', style:{background:'var(--allowed-bg)', color:'var(--allowed)', border:'1px solid #D1D5DB'}}, 'ALLOWED'),
            e('p', {className: 'title', style:{margin:0, flex: 1}}, item.rationale)
        ]),
        e('div', {className: 'issue-meta', style:{borderTop: '1px solid var(--line)', paddingTop: '8px'}}, [
            e(LocatorPill, {loc: item.locator}),
            e('span', {className: 'mono muted'}, item.file)
        ])
      ]);

       // Group drifts by file
       function groupDriftsByFile(drifts) {
         const grouped = {};
         drifts.forEach(drift => {
           const file = drift.file;
           if (!grouped[file]) {
             grouped[file] = [];
           }
           grouped[file].push(drift);
         });
         return grouped;
       }

       // File-level container component
       function FileGroup({fileName, drifts, Component, riskLevel}) {
         const [isExpanded, setIsExpanded] = React.useState(false);
         
         // Determine styling based on risk level
         let fileRiskColor, fileRiskIcon, fileRiskLabel;
         
         switch(riskLevel) {
           case 'high':
             fileRiskColor = 'var(--vz-red)';
             fileRiskIcon = '🔴';
             fileRiskLabel = 'High Risk';
             break;
           case 'medium':
             fileRiskColor = 'var(--med)';
             fileRiskIcon = '🟠';
             fileRiskLabel = 'Medium Risk';
             break;
           case 'low':
             fileRiskColor = 'var(--low)';
             fileRiskIcon = '🟢';
             fileRiskLabel = 'Low Risk';
             break;
           case 'allowed':
             fileRiskColor = 'var(--allowed)';
             fileRiskIcon = '✅';
             fileRiskLabel = 'Allowed Variance';
             break;
           default:
             fileRiskColor = 'var(--low)';
             fileRiskIcon = '🟢';
             fileRiskLabel = 'Mixed Risk';
         }
         
         const totalDrifts = drifts.length;
         
         return e('div', {className: 'file-group-card', style:{
           border: `2px solid ${fileRiskColor}`,
           borderRadius: '12px',
           marginBottom: '20px',
           overflow: 'hidden'
         }}, [
           // File header
           e('div', {
             className: 'file-header',
             style: {
               backgroundColor: fileRiskColor + '15',
               padding: '16px 20px',
               cursor: 'pointer',
               display: 'flex',
               justifyContent: 'space-between',
               alignItems: 'center',
               borderBottom: isExpanded ? `1px solid ${fileRiskColor}40` : 'none'
             },
             onClick: () => setIsExpanded(!isExpanded)
           }, [
             e('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}}, [
               e('span', {style: {fontSize: '20px'}}, fileRiskIcon),
               e('div', null, [
                 e('div', {style: {fontWeight: '600', fontSize: '16px', color: fileRiskColor}}, fileName),
                 e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 
                   `${totalDrifts} drift${totalDrifts !== 1 ? 's' : ''} • ${fileRiskLabel}`)
               ])
             ]),
             e('div', {style: {fontSize: '24px', color: fileRiskColor}}, isExpanded ? '−' : '+')
           ]),
           
           // File content (collapsible)
           isExpanded && e('div', {style: {padding: '0'}}, [
             e('div', {className: 'grid-issues'}, drifts.map((drift, i) => 
               e(Component, {key: i, item: drift, bucket: 'file-group'})
             ))
           ])
         ]);
       }

       // Sort files by risk priority (High > Medium > Low > Allowed)
       function sortFilesByRisk(fileGroups) {
         const riskPriority = { high: 4, medium: 3, low: 2, allowed: 1 };
         
         return Object.keys(fileGroups).sort((fileNameA, fileNameB) => {
           const driftsA = fileGroups[fileNameA];
           const driftsB = fileGroups[fileNameB];
           
           // Get highest risk level for each file
           const maxRiskA = Math.max(...driftsA.map(d => riskPriority[d._riskLevel] || 0));
           const maxRiskB = Math.max(...driftsB.map(d => riskPriority[d._riskLevel] || 0));
           
           // Sort by risk level first (highest first)
           if (maxRiskA !== maxRiskB) {
             return maxRiskB - maxRiskA;
           }
           
           // If same risk level, sort alphabetically
           return fileNameA.localeCompare(fileNameB);
         });
       }

       // Special component for showing all drifts grouped by file
       function AllDriftsByFile({data}) {
         if (!data) return null;
         
         // Combine all drifts from all risk levels
         const allDrifts = [
           ...(data.high || []).map(d => ({...d, _riskLevel: 'high'})),
           ...(data.medium || []).map(d => ({...d, _riskLevel: 'medium'})),
           ...(data.low || []).map(d => ({...d, _riskLevel: 'low'})),
           ...(data.allowed_variance || []).map(d => ({...d, _riskLevel: 'allowed'}))
         ];
         
         // Group by file
         const fileGroups = groupDriftsByFile(allDrifts);
         const fileNames = sortFilesByRisk(fileGroups);
         
         return e('div', null, [
           e('h2', {className: 'section-title', style:{color: '#333', borderBottom: '2px solid #333'}}, 
             '📁 All Drifts by File'),
           e('div', {style: {marginTop: '16px'}}, fileNames.map(fileName => 
             e(FileGroupAll, {key: fileName, fileName, drifts: fileGroups[fileName]})
           ))
         ]);
       }

       // File group component for mixed risk levels
       function FileGroupAll({fileName, drifts}) {
         const [isExpanded, setIsExpanded] = React.useState(false);
         
         // Count drifts by risk level
         const riskCounts = {
           high: drifts.filter(d => d._riskLevel === 'high').length,
           medium: drifts.filter(d => d._riskLevel === 'medium').length,
           low: drifts.filter(d => d._riskLevel === 'low').length,
           allowed: drifts.filter(d => d._riskLevel === 'allowed').length
         };
         
         // Determine primary risk level (highest risk present)
         let fileRiskColor, fileRiskIcon, fileRiskLabel;
         if (riskCounts.high > 0) {
           fileRiskColor = 'var(--vz-red)';
           fileRiskIcon = '🔴';
           fileRiskLabel = 'High Risk';
         } else if (riskCounts.medium > 0) {
           fileRiskColor = 'var(--med)';
           fileRiskIcon = '🟠';
           fileRiskLabel = 'Medium Risk';
         } else if (riskCounts.low > 0) {
           fileRiskColor = 'var(--low)';
           fileRiskIcon = '🟢';
           fileRiskLabel = 'Low Risk';
         } else {
           fileRiskColor = 'var(--allowed)';
           fileRiskIcon = '✅';
           fileRiskLabel = 'Allowed Variance';
         }
         
         const totalDrifts = drifts.length;
         const riskSummary = [
           riskCounts.high > 0 && `${riskCounts.high} high`,
           riskCounts.medium > 0 && `${riskCounts.medium} medium`,
           riskCounts.low > 0 && `${riskCounts.low} low`,
           riskCounts.allowed > 0 && `${riskCounts.allowed} allowed`
         ].filter(Boolean).join(', ');
         
         return e('div', {className: 'file-group-card', style:{
           border: `2px solid ${fileRiskColor}`,
           borderRadius: '12px',
           marginBottom: '20px',
           overflow: 'hidden'
         }}, [
           // File header
           e('div', {
             className: 'file-header',
             style: {
               backgroundColor: fileRiskColor + '15',
               padding: '16px 20px',
               cursor: 'pointer',
               display: 'flex',
               justifyContent: 'space-between',
               alignItems: 'center',
               borderBottom: isExpanded ? `1px solid ${fileRiskColor}40` : 'none'
             },
             onClick: () => setIsExpanded(!isExpanded)
           }, [
             e('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}}, [
               e('span', {style: {fontSize: '20px'}}, fileRiskIcon),
               e('div', null, [
                 e('div', {style: {fontWeight: '600', fontSize: '16px', color: fileRiskColor}}, fileName),
                 e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 
                   `${totalDrifts} drift${totalDrifts !== 1 ? 's' : ''} • ${riskSummary}`)
               ])
             ]),
             e('div', {style: {fontSize: '24px', color: fileRiskColor}}, isExpanded ? '−' : '+')
           ]),
           
           // File content (collapsible) - group by risk level
           isExpanded && e('div', {style: {padding: '0'}}, [
             riskCounts.high > 0 && e('div', {style: {marginBottom: '16px'}}, [
               e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--vz-red)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, '🔴 High Risk'),
               e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'high').map((drift, i) => 
                 e(Issue, {key: i, item: drift, bucket: 'high'})
               ))
             ]),
             riskCounts.medium > 0 && e('div', {style: {marginBottom: '16px'}}, [
               e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--med)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, '🟠 Medium Risk'),
               e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'medium').map((drift, i) => 
                 e(Issue, {key: i, item: drift, bucket: 'medium'})
               ))
             ]),
             riskCounts.low > 0 && e('div', {style: {marginBottom: '16px'}}, [
               e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--low)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, '🟢 Low Risk'),
               e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'low').map((drift, i) => 
                 e(Issue, {key: i, item: drift, bucket: 'low'})
               ))
             ]),
             riskCounts.allowed > 0 && e('div', {style: {marginBottom: '16px'}}, [
               e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--allowed)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, '✅ Allowed Variance'),
               e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'allowed').map((drift, i) => 
                 e(AllowedVarianceIssue, {key: i, item: drift, bucket: 'allowed'})
               ))
             ])
           ])
         ]);
       }

       function Bucket({title, items, kind, riskColor, Component}){ 
         if (!items || items.length === 0) return null;
         
         // Group items by file and add risk level metadata
         const itemsWithRisk = items.map(item => ({...item, _riskLevel: kind}));
         const fileGroups = groupDriftsByFile(itemsWithRisk);
         const fileNames = sortFilesByRisk(fileGroups);
         
         return e('div',null, [
           e('h2', {className: 'section-title', style:{color: riskColor, borderBottom: `2px solid ${riskColor}`}}, title),
           e('div', {style: {marginTop: '16px'}}, fileNames.map(fileName => 
             e(FileGroup, {key: fileName, fileName, drifts: fileGroups[fileName], Component, riskLevel: kind})
           ))
         ]); 
       }

      function App(){
        const [data,setData] = React.useState(null);
        const [loading,setLoading] = React.useState(false);
        const [error,setError] = React.useState(null);
        const [autoLoaded,setAutoLoaded] = React.useState(false);
        const [activeFilter,setActiveFilter] = React.useState('all'); // 'all', 'high', 'medium', 'low', 'allowed'

        // Filter functions
        function handleFilterClick(filter) {
          setActiveFilter(filter);
        }

        function getFilteredData() {
          if (!data || activeFilter === 'all') return data;
          
          const filtered = {
            summary: data.summary,
            high: activeFilter === 'high' ? data.high : [],
            medium: activeFilter === 'medium' ? data.medium : [],
            low: activeFilter === 'low' ? data.low : [],
            allowed_variance: activeFilter === 'allowed' ? data.allowed_variance : []
          };
          
          return filtered;
        }

        // Auto-load from API on mount
        React.useEffect(() => {
          if (!autoLoaded) {
            loadFromAPI();
            setAutoLoaded(true);
          }
        }, []);

        async function runAnalysis() {
          setLoading(true);
          setError(null);
          setData(null);
          try {
            // Trigger validation
            const response = await fetch('/api/validate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });
            
            if (!response.ok) {
              throw new Error(`Analysis failed: ${response.status}`);
            }
            
            // Wait a moment for files to be written
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Load results
            await loadFromAPI();
          } catch (ex) {
            setError(ex.message);
            setLoading(false);
          }
        }

        async function loadFromAPI() {
          setLoading(true);
          setError(null);
          try {
            const response = await fetch('/api/llm-output');
            if (!response.ok) {
              if (response.status === 404) {
                throw new Error('No analysis results available yet. Click "Run Analysis" first.');
              }
              throw new Error(`API error: ${response.status}`);
            }
            const json = await response.json();
            if (json.status === 'success' && json.data) {
              setData(json.data);
            } else {
              throw new Error('Invalid API response format');
            }
          } catch (ex) {
            setError(ex.message);
          } finally {
            setLoading(false);
          }
        }

        function onFile(ev){ 
            const f = ev.target?.files?.[0]; if(!f) return; 
            const r = new FileReader(); 
            r.onload = e => { 
              try{ 
                const obj = JSON.parse(String(e.target.result)); 
                setData(obj);
                setError(null);
              } catch(ex){ 
                setError('Invalid JSON file: '+ex.message); 
              } 
            }; 
            r.readAsText(f);
        }

        function downloadFullJSON() {
          if (!data) return;
          const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'llm_output_full.json';
          a.click();
          URL.revokeObjectURL(a.href);
        }

        // Use filtered data for display
        const displayData = getFilteredData();
        
        // Extract ALL statistics from LLM output summary (not calculated in UI)
        const summary = displayData?.summary || {};
        const totalConfigFiles = summary.total_config_files || 0;
        const filesWithDrift = summary.files_with_drift || 0;
        const totalDrifts = summary.total_drifts || 0;
        
        // Risk counts from LLM output summary (not from array lengths)
        const counts = { 
          high: summary.high_risk || 0, 
          medium: summary.medium_risk || 0, 
          low: summary.low_risk || 0, 
          allowed: summary.allowed_variance || 0 
        };

        return e('div',null,[
          e('div',{className:'header'},[
            e('div',{className:'container'},[
              e('div', {style:{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: '16px'}},[
                e('h1', {style:{fontSize: '24px'}}, '🔍 Golden Config AI - Drift Review Assistant'),
                e('div', {style:{display:'flex', gap:'8px'}}, [
                  e('button', {className: 'btn success', onClick: runAnalysis, disabled: loading}, loading ? 'Running Analysis...' : '▶️ Run Analysis'),
                  e('button', {className: 'btn', onClick: loadFromAPI, disabled: loading}, '🔄 Refresh Results'),
                  e('input',{type:'file', id:'file-upload', accept:'.json,application/json',style:{display:'none'},onChange:onFile}),
                  e('label', {htmlFor:'file-upload', className: 'btn'}, '📁 Upload JSON'),
                  data && e('button', {className: 'btn', onClick: downloadFullJSON}, '⬇️ Download')
                ])
              ]),
              e('div',{className:'stats', style:{margin:'0 -8px', padding:'0 8px'}},[
                // Summary Statistics (Top Row) - Clickable filters
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'all' ? '#e3f2fd' : '#f8f9fa', 
                  border: activeFilter === 'all' ? '3px solid #007bff' : '2px solid #007bff',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('all')}, [
                  e('div',{className:'lbl'}, 'Total Config Files'), 
                  e('div',{className:'val', style:{color:'#007bff'}}, totalConfigFiles)
                ]),
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'all' ? '#fff8e1' : '#fff3cd', 
                  border: activeFilter === 'all' ? '3px solid #ffc107' : '2px solid #ffc107',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('all')}, [
                  e('div',{className:'lbl'}, 'Files with Drift'), 
                  e('div',{className:'val', style:{color:'#856404'}}, filesWithDrift)
                ]),
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'all' ? '#e0f7fa' : '#d1ecf1', 
                  border: activeFilter === 'all' ? '3px solid #17a2b8' : '2px solid #17a2b8',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('all')}, [
                  e('div',{className:'lbl'}, 'Total Drifts'), 
                  e('div',{className:'val', style:{color:'#0c5460'}}, totalDrifts)
                ]),
                // Risk Categories (Bottom Row) - Clickable filters
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'high' ? '#ffebee' : 'white', 
                  border: activeFilter === 'high' ? '3px solid var(--vz-red)' : '1px solid var(--line)',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('high')}, [
                  e('div',{className:'lbl'}, 'High Risk'), 
                  e('div',{className:'val', style:{color:'var(--vz-red)'}}, counts.high)
                ]),
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'medium' ? '#fff3e0' : 'white', 
                  border: activeFilter === 'medium' ? '3px solid var(--med)' : '1px solid var(--line)',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('medium')}, [
                  e('div',{className:'lbl'}, 'Medium Risk'), 
                  e('div',{className:'val', style:{color:'var(--med)'}}, counts.medium)
                ]),
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'low' ? '#f3e5f5' : 'white', 
                  border: activeFilter === 'low' ? '3px solid var(--low)' : '1px solid var(--line)',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('low')}, [
                  e('div',{className:'lbl'}, 'Low Risk'), 
                  e('div',{className:'val', style:{color:'var(--low)'}}, counts.low)
                ]),
                e('div', {className:'card stat clickable', style:{
                  backgroundColor: activeFilter === 'allowed' ? '#e8f5e8' : 'white', 
                  border: activeFilter === 'allowed' ? '3px solid var(--allowed)' : '1px solid var(--line)',
                  cursor: 'pointer'
                }, onClick: () => handleFilterClick('allowed')}, [
                  e('div',{className:'lbl'}, 'Allowed Variance'), 
                  e('div',{className:'val', style:{color:'var(--allowed)'}}, counts.allowed)
                ])
              ])
            ])
          ]),
          e('div',{className:'container'},[
            error && e('div',{className:'card error', style:{marginBottom:'16px'}}, error),
            loading && e('div',{className:'loading'}, [e('div',{className:'spinner'}), e('p',{style:{marginTop:'16px'}}, 'Loading analysis results...')]),
            !loading && !data && !error && e('div',{className:'card muted', style:{textAlign:'center', padding: '48px'}}, [
              e('p',{style:{fontSize:'18px',marginBottom:'8px'}}, '👋 Welcome to the AI Drift Review Assistant'),
              e('p',null,'Click "▶️ Run Analysis" to start a new drift analysis, "🔄 Refresh Results" to load latest, or "📁 Upload JSON" to load a saved file.')
            ]),
            !loading && data && e('div', {className: 'grid-issues', style:{gap: '32px'}}, [
              counts.high + counts.medium + counts.low + counts.allowed === 0 ? 
                e('div',{className:'success-banner'}, [
                  e('p',{style:{fontSize:'18px',fontWeight:'bold',marginBottom:'4px'}}, activeFilter === 'all' ? '✅ No Drift Detected' : `✅ No ${activeFilter} risk items found`),
                  e('p',{style:{margin:0}}, activeFilter === 'all' ? 'All configurations match the golden state. No action required.' : `Try clicking "Total Drifts" to see all items.`)
                ]) : null,
              
              // Show file-grouped view when "all" is selected, otherwise show risk-grouped view
              activeFilter === 'all' ? 
                e(AllDriftsByFile, {data: data}) : [
                  e(Bucket,{title:'🔴 High Risk Changes', items: displayData.high, kind:'high', riskColor: 'var(--vz-red)', Component: Issue}),
                  e(Bucket,{title:'🟠 Medium Risk Changes', items: displayData.medium, kind:'medium', riskColor: 'var(--med)', Component: Issue}),
                  e(Bucket,{title:'🟢 Low Risk Changes', items: displayData.low, kind:'low', riskColor: 'var(--low)', Component: Issue}),
                  e(Bucket,{title:'✅ Allowed Variance', items: displayData.allowed_variance, kind:'allowed', riskColor: 'var(--allowed)', Component: AllowedVarianceIssue})
                ]
            ])
          ])
        ]);
      }

      ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    })();
  </script>
</body>
</html>
