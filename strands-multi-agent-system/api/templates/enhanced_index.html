<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Config AI - Enhanced Drift Analysis Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .agent-status {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            display: inline-block;
        }
        
        .status-indicator {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .controls {
            padding: 30px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 120px;
        }
        
        .control-group input, .control-group select {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .status {
            padding: 20px 30px;
            margin: 20px 30px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }
        
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 2px solid #bbdefb;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #c8e6c9;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ffcdd2;
        }
        
        .results {
            padding: 30px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-card.clusters {
            border-left-color: #28a745;
        }
        
        .summary-card.clusters .value {
            color: #28a745;
        }
        
        .summary-card.evidence {
            border-left-color: #ffc107;
        }
        
        .summary-card.evidence .value {
            color: #ffc107;
        }
        
        .summary-card.pinpoint {
            border-left-color: #17a2b8;
        }
        
        .summary-card.pinpoint .value {
            color: #17a2b8;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
        }
        
        .cluster-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .cluster-header {
            background: #e8f5e8;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cluster-header:hover {
            background: #d4edda;
        }
        
        .cluster-body {
            padding: 20px;
            display: none;
        }
        
        .cluster-card.expanded .cluster-body {
            display: block;
        }
        
        .drift-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .drift-item-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .drift-item-header:hover {
            background: #e9ecef;
        }
        
        .drift-item-body {
            padding: 20px;
            display: none;
        }
        
        .drift-item.expanded .drift-item-body {
            display: block;
        }
        
        .risk-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .risk-critical {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .risk-high {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .risk-medium {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .risk-low {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .evidence-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .evidence-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .evidence-partial {
            background: #fff3cd;
            color: #856404;
        }
        
        .evidence-pending {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .evidence-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .patch-hint {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .patch-hint h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .patch-code {
            background: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow: auto;
            max-height: 300px;
            margin-top: 10px;
            white-space: pre;
        }
        
        .pinpoint-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .pinpoint-link:hover {
            text-decoration: underline;
        }
        
        .diff-content {
            background: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow: auto;
            max-height: 320px;
            margin-top: 10px;
            white-space: pre;
        }
        
        .diff-line {
            padding: 2px 5px;
            margin: 1px 0;
        }
        
        .diff-added {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-removed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .diff-context {
            color: #6c757d;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pii-notice {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .insight-card {
            background: #fefce8;
            border-left: 4px solid #fbbf24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .insight-card h4 {
            color: #92400e;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .control-group {
                flex-direction: column;
            }
            
            .control-group label {
                min-width: auto;
            }
            
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Golden Config AI - Enhanced Analysis</h1>
            <p>Intelligent Configuration Drift Detection with Advanced Features</p>
            <div id="agent-status" class="agent-status">
                <span class="status-indicator" id="status-indicator">🤖</span>
                <span id="status-text">Checking agent status...</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Repository URL:</label>
                <input type="text" id="repoUrl" placeholder="https://gitlab.com/user/repo.git" value="">
            </div>
            <div class="control-group">
                <label>Golden Branch:</label>
                <input type="text" id="goldenBranch" placeholder="main" value="main">
            </div>
            <div class="control-group">
                <label>Drift Branch:</label>
                <input type="text" id="driftBranch" placeholder="feature-branch" value="">
            </div>
            <div class="control-group">
                <label>Environment:</label>
                <select id="environment">
                    <option value="production">Production</option>
                    <option value="staging">Staging</option>
                    <option value="development">Development</option>
                </select>
            </div>
            
            <div class="control-group">
                <button class="btn" onclick="runValidation()">🔍 Run Complete Validation</button>
                <button class="btn secondary" onclick="loadSampleData()">📊 Load Sample Data</button>
                <button class="btn danger" onclick="clearResults()">🗑️ Clear Results</button>
            </div>
        </div>
        
        <div id="status" class="status hidden"></div>
        
        <div id="results" class="results hidden">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Files Analyzed</h3>
                    <div class="value" id="totalFiles">0</div>
                </div>
                <div class="summary-card">
                    <h3>Files with Drift</h3>
                    <div class="value" id="driftFiles">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Deltas</h3>
                    <div class="value" id="totalDeltas">0</div>
                </div>
                <div class="summary-card clusters">
                    <h3>Clusters</h3>
                    <div class="value" id="totalClusters">0</div>
                </div>
                <div class="summary-card pinpoint">
                    <h3>Pinpoint Locations</h3>
                    <div class="value" id="pinpointLocations">0</div>
                </div>
                <div class="summary-card evidence">
                    <h3>Evidence Checks</h3>
                    <div class="value" id="evidenceChecks">0</div>
                </div>
                <div class="summary-card">
                    <h3>Policy Violations</h3>
                    <div class="value" id="policyViolations">0</div>
                </div>
                <div class="summary-card">
                    <h3>Overall Risk</h3>
                    <div class="value" id="overallRisk">-</div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">📊 Overview</button>
                <button class="tab" onclick="switchTab('clusters')">🔗 Clusters</button>
                <button class="tab" onclick="switchTab('deltas')">📋 Deltas</button>
                <button class="tab" onclick="switchTab('evidence')">🔍 Evidence</button>
                <button class="tab" onclick="switchTab('pinpoint')">📍 Navigation</button>
                <button class="tab" onclick="switchTab('patches')">🔧 Patches</button>
            </div>
            
            <div id="overview-tab" class="tab-content active">
                <div class="section">
                    <h2>🎯 Validation Summary</h2>
                    <div id="validationSummary"></div>
                </div>
                <div class="section">
                    <h2>⚠️ Policy Violations</h2>
                    <div id="policyViolationsList"></div>
                </div>
                <div class="section">
                    <h2>📊 Risk Assessment</h2>
                    <div id="riskAssessment"></div>
                </div>
            </div>
            
            <div id="clusters-tab" class="tab-content">
                <div class="section">
                    <h2>🔗 Change Clusters</h2>
                    <div id="clustersList"></div>
                </div>
            </div>
            
            <div id="deltas-tab" class="tab-content">
                <div class="section">
                    <h2>📋 Detailed Deltas</h2>
                    <div id="deltasList"></div>
                </div>
            </div>
            
            <div id="evidence-tab" class="tab-content">
                <div class="section">
                    <h2>🔍 Evidence Checking</h2>
                    <div id="evidenceList"></div>
                </div>
            </div>
            
            <div id="pinpoint-tab" class="tab-content">
                <div class="section">
                    <h2>📍 Pinpoint Locations</h2>
                    <div id="pinpointList"></div>
                </div>
            </div>
            
            <div id="patches-tab" class="tab-content">
                <div class="section">
                    <h2>🔧 Patch Hints</h2>
                    <div id="patchesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentValidationData = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkAgentStatus();
        });
        
        async function runValidation() {
            showStatus('Running complete validation with all agents...', 'loading');
            
            try {
                const repoUrl = document.getElementById('repoUrl').value;
                const goldenBranch = document.getElementById('goldenBranch').value;
                const driftBranch = document.getElementById('driftBranch').value;
                const environment = document.getElementById('environment').value;
                
                if (!repoUrl || !goldenBranch || !driftBranch) {
                    throw new Error('Please provide repository URL, golden branch, and drift branch');
                }
                
                const response = await fetch('/api/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        repo_url: repoUrl,
                        golden_branch: goldenBranch,
                        drift_branch: driftBranch,
                        environment: environment
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentValidationData = data;
                    displayResults(data);
                    showStatus('✅ Complete validation completed successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Validation failed');
                }
                
            } catch (error) {
                console.error('Validation failed:', error);
                showStatus(`❌ Validation failed: ${error.message}`, 'error');
            }
        }
        
        async function checkAgentStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                if (data.status === 'ready') {
                    statusIndicator.textContent = '✅';
                    statusText.textContent = `Agents Ready: ${data.agents || 'All systems operational'}`;
                } else {
                    statusIndicator.textContent = '🔄';
                    statusText.textContent = 'Initializing agents...';
                }
            } catch (error) {
                console.error('Failed to check agent status:', error);
                document.getElementById('status-indicator').textContent = '❌';
                document.getElementById('status-text').textContent = 'Agent status unknown';
            }
        }
        
        function loadSampleData() {
            // Load sample data for demonstration
            const sampleData = {
                success: true,
                files_analyzed: 15,
                files_with_drift: 8,
                total_deltas: 23,
                total_clusters: 4,
                overall_risk_level: "medium",
                verdict: "REVIEW_REQUIRED",
                clusters: [
                    {
                        id: "cluster_pattern_ssl_tls",
                        root_cause: "SSL/TLS configuration changes across 3 files",
                        type: "configuration_pattern",
                        severity: "critical",
                        verdict: "DRIFT_BLOCKING",
                        items: ["cfg~server.yml.ssl", "cfg~gateway.yml.tls", "cfg~api.yml.https"],
                        files: ["server.yml", "gateway.yml", "api.yml"]
                    }
                ],
                analyzed_deltas: [
                    {
                        file: "server.yml",
                        risk_level: "critical",
                        verdict: "DRIFT_BLOCKING",
                        policy_violations: ["SSL disabled in production"],
                        patch_hint: {
                            type: "yaml_snippet",
                            content: "server:\n  ssl:\n    enabled: true"
                        },
                        pinpoint: {
                            location_string: "server.yml:45:4",
                            human_readable: "server.yml at line 45, column 4-8 (YAML Path)",
                            ide_links: {
                                vs_code: "vscode://file/server.yml:45:4"
                            }
                        },
                        evidence_check: {
                            approval_status: "rejected",
                            compliance_score: 0.0,
                            validation_summary: "❌ Insufficient evidence (0/2) - Change blocked"
                        }
                    }
                ]
            };
            
            currentValidationData = sampleData;
            displayResults(sampleData);
            showStatus('📊 Sample data loaded successfully', 'success');
        }
        
        function clearResults() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('status').classList.add('hidden');
            currentValidationData = null;
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.classList.remove('hidden');
            
            if (type === 'loading') {
                statusEl.innerHTML = `<div class="loading-spinner"></div><p>${message}</p>`;
            }
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        function displayResults(data) {
            const resultsEl = document.getElementById('results');
            resultsEl.classList.remove('hidden');
            
            // Update summary cards
            document.getElementById('totalFiles').textContent = data.files_analyzed || 0;
            document.getElementById('driftFiles').textContent = data.files_with_drift || 0;
            document.getElementById('totalDeltas').textContent = data.total_deltas || 0;
            document.getElementById('totalClusters').textContent = data.total_clusters || 0;
            document.getElementById('pinpointLocations').textContent = (data.analyzed_deltas || []).filter(d => d.pinpoint).length;
            document.getElementById('evidenceChecks').textContent = (data.analyzed_deltas || []).filter(d => d.evidence_check).length;
            document.getElementById('policyViolations').textContent = (data.analyzed_deltas || []).reduce((sum, d) => sum + (d.policy_violations?.length || 0), 0);
            document.getElementById('overallRisk').textContent = (data.overall_risk_level || 'unknown').toUpperCase();
            
            // Display tab contents
            displayOverview(data);
            displayClusters(data);
            displayDeltas(data);
            displayEvidence(data);
            displayPinpoint(data);
            displayPatches(data);
        }
        
        function displayOverview(data) {
            const summaryEl = document.getElementById('validationSummary');
            const violationsEl = document.getElementById('policyViolationsList');
            const riskEl = document.getElementById('riskAssessment');
            
            // Validation Summary
            summaryEl.innerHTML = `
                <div class="insight-card">
                    <h4>🎯 Validation Result</h4>
                    <p><strong>Verdict:</strong> ${data.verdict || 'UNKNOWN'}</p>
                    <p><strong>Overall Risk:</strong> ${(data.overall_risk_level || 'unknown').toUpperCase()}</p>
                    <p><strong>Analysis Type:</strong> Policy-Aware (drift.py + AI + Clustering + Pinpoint + Evidence)</p>
                </div>
            `;
            
            // Policy Violations
            const violations = (data.analyzed_deltas || []).flatMap(d => d.policy_violations || []);
            if (violations.length > 0) {
                violationsEl.innerHTML = violations.map(violation => `
                    <div class="insight-card">
                        <h4>⚠️ Policy Violation</h4>
                        <p>${violation}</p>
                    </div>
                `).join('');
            } else {
                violationsEl.innerHTML = '<p class="muted">No policy violations detected.</p>';
            }
            
            // Risk Assessment
            riskEl.innerHTML = `
                <div class="insight-card">
                    <h4>📊 Risk Assessment</h4>
                    <p><strong>Risk Level:</strong> ${(data.overall_risk_level || 'unknown').toUpperCase()}</p>
                    <p><strong>Files with Drift:</strong> ${data.files_with_drift || 0} of ${data.files_analyzed || 0}</p>
                    <p><strong>Recommendation:</strong> ${getRiskRecommendation(data.overall_risk_level)}</p>
                </div>
            `;
        }
        
        function displayClusters(data) {
            const clustersEl = document.getElementById('clustersList');
            const clusters = data.clusters || [];
            
            if (clusters.length === 0) {
                clustersEl.innerHTML = '<p class="muted">No clusters identified.</p>';
                return;
            }
            
            clustersEl.innerHTML = clusters.map((cluster, index) => `
                <div class="cluster-card" id="cluster-${index}">
                    <div class="cluster-header" onclick="toggleCluster(${index})">
                        <div>
                            <strong>${cluster.root_cause}</strong>
                            <span class="risk-badge risk-${cluster.severity}">${cluster.severity}</span>
                            <span class="evidence-status evidence-${cluster.verdict === 'DRIFT_BLOCKING' ? 'rejected' : 'pending'}">${cluster.verdict}</span>
                        </div>
                        <span>▼</span>
                    </div>
                    <div class="cluster-body">
                        <p><strong>Type:</strong> ${cluster.type.replace('_', ' ')}</p>
                        <p><strong>Files:</strong> ${cluster.files?.join(', ') || 'N/A'}</p>
                        <p><strong>Items:</strong> ${cluster.items?.length || 0} deltas</p>
                    </div>
                </div>
            `).join('');
        }
        
        function displayDeltas(data) {
            const deltasEl = document.getElementById('deltasList');
            const deltas = data.analyzed_deltas || [];
            
            if (deltas.length === 0) {
                deltasEl.innerHTML = '<p class="muted">No deltas analyzed.</p>';
                return;
            }
            
            deltasEl.innerHTML = deltas.map((delta, index) => `
                <div class="drift-item" id="delta-${index}">
                    <div class="drift-item-header" onclick="toggleDelta(${index})">
                        <div>
                            <strong>${delta.file}</strong>
                            <span class="risk-badge risk-${delta.risk_level}">${delta.risk_level}</span>
                            <span class="evidence-status evidence-${delta.evidence_check?.approval_status || 'unknown'}">${delta.evidence_check?.approval_status || 'unknown'}</span>
                        </div>
                        <span>▼</span>
                    </div>
                    <div class="drift-item-body">
                        <p><strong>Verdict:</strong> ${delta.verdict}</p>
                        <p><strong>Risk Level:</strong> ${delta.risk_level}</p>
                        ${delta.policy_violations?.length > 0 ? `<p><strong>Policy Violations:</strong> ${delta.policy_violations.join(', ')}</p>` : ''}
                        ${delta.recommendations?.length > 0 ? `<p><strong>Recommendations:</strong> ${delta.recommendations.join(', ')}</p>` : ''}
                        ${delta.pinpoint ? `<p><strong>Location:</strong> <a href="${delta.pinpoint.ide_links?.vs_code || '#'}" class="pinpoint-link">${delta.pinpoint.human_readable}</a></p>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function displayEvidence(data) {
            const evidenceEl = document.getElementById('evidenceList');
            const deltas = (data.analyzed_deltas || []).filter(d => d.evidence_check);
            
            if (deltas.length === 0) {
                evidenceEl.innerHTML = '<p class="muted">No evidence checks performed.</p>';
                return;
            }
            
            const grouped = {
                approved: deltas.filter(d => d.evidence_check.approval_status === 'approved'),
                partial: deltas.filter(d => d.evidence_check.approval_status === 'partial_approval'),
                pending: deltas.filter(d => d.evidence_check.approval_status === 'pending_review'),
                rejected: deltas.filter(d => d.evidence_check.approval_status === 'rejected')
            };
            
            evidenceEl.innerHTML = `
                ${grouped.rejected.length > 0 ? `
                    <h3>❌ Blocked Changes (${grouped.rejected.length})</h3>
                    ${grouped.rejected.map(delta => `
                        <div class="insight-card">
                            <h4>${delta.file}</h4>
                            <p><strong>Status:</strong> ${delta.evidence_check.validation_summary}</p>
                            <p><strong>Compliance:</strong> ${(delta.evidence_check.compliance_score * 100).toFixed(0)}%</p>
                        </div>
                    `).join('')}
                ` : ''}
                
                ${grouped.pending.length > 0 ? `
                    <h3>🔄 Pending Review (${grouped.pending.length})</h3>
                    ${grouped.pending.map(delta => `
                        <div class="insight-card">
                            <h4>${delta.file}</h4>
                            <p><strong>Status:</strong> ${delta.evidence_check.validation_summary}</p>
                        </div>
                    `).join('')}
                ` : ''}
                
                ${grouped.approved.length > 0 ? `
                    <h3>✅ Fully Approved (${grouped.approved.length})</h3>
                    ${grouped.approved.map(delta => `
                        <div class="insight-card">
                            <h4>${delta.file}</h4>
                            <p><strong>Status:</strong> ${delta.evidence_check.validation_summary}</p>
                        </div>
                    `).join('')}
                ` : ''}
            `;
        }
        
        function displayPinpoint(data) {
            const pinpointEl = document.getElementById('pinpointList');
            const deltas = (data.analyzed_deltas || []).filter(d => d.pinpoint);
            
            if (deltas.length === 0) {
                pinpointEl.innerHTML = '<p class="muted">No pinpoint locations available.</p>';
                return;
            }
            
            pinpointEl.innerHTML = deltas.slice(0, 10).map(delta => `
                <div class="insight-card">
                    <h4>📍 ${delta.pinpoint.human_readable}</h4>
                    <p><strong>Location:</strong> <code>${delta.pinpoint.location_string}</code></p>
                    <p><strong>Type:</strong> ${delta.pinpoint.navigation?.type || 'Unknown'}</p>
                    ${delta.pinpoint.ide_links?.vs_code ? `<p><strong>VS Code:</strong> <a href="${delta.pinpoint.ide_links.vs_code}" class="pinpoint-link">Open in VS Code</a></p>` : ''}
                    ${delta.pinpoint.navigation?.vs_code_command ? `<p><strong>Command:</strong> ${delta.pinpoint.navigation.vs_code_command}</p>` : ''}
                </div>
            `).join('');
        }
        
        function displayPatches(data) {
            const patchesEl = document.getElementById('patchesList');
            const deltas = (data.analyzed_deltas || []).filter(d => d.patch_hint);
            
            if (deltas.length === 0) {
                patchesEl.innerHTML = '<p class="muted">No patch hints available.</p>';
                return;
            }
            
            patchesEl.innerHTML = deltas.map((delta, index) => `
                <div class="patch-hint">
                    <h4>🔧 ${delta.file}</h4>
                    <p><strong>Issue:</strong> ${delta.verdict}</p>
                    <p><strong>Patch Type:</strong> ${delta.patch_hint.type}</p>
                    <div class="patch-code">${escapeHtml(delta.patch_hint.content)}</div>
                    <button class="btn secondary" onclick="downloadPatch('${delta.file}', '${escapeHtml(delta.patch_hint.content)}')">📥 Download Patch</button>
                </div>
            `).join('');
        }
        
        function toggleCluster(index) {
            const cluster = document.getElementById(`cluster-${index}`);
            if (!cluster) return;
            
            const header = cluster.querySelector('.cluster-header');
            const arrow = header ? header.querySelector('span:last-child') : null;
            
            const isExpanded = cluster.classList.toggle('expanded');
            if (arrow) arrow.textContent = isExpanded ? '▲' : '▼';
        }
        
        function toggleDelta(index) {
            const delta = document.getElementById(`delta-${index}`);
            if (!delta) return;
            
            const header = delta.querySelector('.drift-item-header');
            const arrow = header ? header.querySelector('span:last-child') : null;
            
            const isExpanded = delta.classList.toggle('expanded');
            if (arrow) arrow.textContent = isExpanded ? '▲' : '▼';
        }
        
        function downloadPatch(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.patch`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function getRiskRecommendation(riskLevel) {
            switch (riskLevel) {
                case 'critical': return 'Immediate action required. Block deployment and review all changes.';
                case 'high': return 'High risk detected. Review changes carefully before deployment.';
                case 'medium': return 'Medium risk. Review and test changes in staging.';
                case 'low': return 'Low risk. Standard review process recommended.';
                default: return 'Risk assessment unavailable.';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
